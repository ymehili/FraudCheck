import logging
from typing import Dict, Any
from io import BytesIO

from ..core.config import settings

logger = logging.getLogger(__name__)


class MalwareScanError(Exception):
    """Exception raised for malware scanning errors."""
    pass


class MalwareDetected(Exception):
    """Exception raised when malware is detected."""
    pass


class MalwareScanner:
    """ClamAV daemon-only malware scanning service."""
    
    def __init__(self):
        self.clamd_socket = settings.CLAMAV_SOCKET_PATH
        self.timeout = settings.CLAMAV_TIMEOUT
        self.enabled = settings.CLAMAV_ENABLED
        
        if self.enabled:
            logger.info(f"Malware scanner initialized. ClamAV socket: {self.clamd_socket}")
        else:
            logger.info("Malware scanning is disabled")

    async def scan_file_content(self, file_content: bytes, filename: str) -> Dict[str, Any]:
        """
        Scan file content for malware using ClamAV daemon only.
        
        Args:
            file_content: Raw file content bytes
            filename: Original filename for context
            
        Returns:
            Dictionary with scan results
            
        Raises:
            MalwareDetected: If malware is found
            MalwareScanError: If scanning fails
        """
        if not self.enabled:
            raise MalwareScanError("Malware scanning is disabled")
        
        try:
            # Single ClamAV scan only, no fallbacks
            result = await self._scan_with_clamd_socket(file_content, filename)
            if not result['clean']:
                raise MalwareDetected(f"Malware detected: {result['threat_name']}")
            return result
        except MalwareDetected:
            # Re-raise malware detection
            raise
        except Exception as e:
            # No fallback - fail immediately
            raise MalwareScanError(f"ClamAV scan failed: {str(e)}")

    async def _scan_with_clamd_socket(self, file_content: bytes, filename: str) -> Dict[str, Any]:
        """Scan file using ClamAV daemon via Unix socket."""
        try:
            import clamd
            
            # Connect to ClamAV daemon via Unix socket
            cd = clamd.ClamdUnixSocket(path=self.clamd_socket)
            
            # Use instream for bytes scanning (not file path)
            result = cd.instream(BytesIO(file_content))
            
            # Parse ClamAV response format
            stream_result = result.get('stream')
            if stream_result and len(stream_result) >= 1 and stream_result[0] == 'OK':
                return {
                    'scanned': True,
                    'scanner': 'clamav',
                    'clean': True,
                    'threat_name': None,
                    'message': 'File is clean'
                }
            else:
                # Extract threat name from result
                if isinstance(stream_result, tuple) and len(stream_result) > 1:
                    threat_name = stream_result[1] if stream_result[1] else 'Unknown threat'
                elif isinstance(stream_result, tuple) and len(stream_result) == 1:
                    threat_name = stream_result[0] if stream_result[0] != 'OK' else 'Unknown threat'
                else:
                    threat_name = str(stream_result) if stream_result else 'Unknown threat'
                
                return {
                    'scanned': True,
                    'scanner': 'clamav', 
                    'clean': False,
                    'threat_name': threat_name,
                    'message': f'Threat detected: {threat_name}'
                }
                
        except ImportError:
            raise MalwareScanError("python-clamd library not installed")
        except Exception as e:
            raise MalwareScanError(f"ClamAV daemon connection failed: {str(e)}")


# Global scanner instance
malware_scanner = MalwareScanner()


async def scan_file_for_malware(file_content: bytes, filename: str) -> Dict[str, Any]:
    """
    Convenience function to scan file content for malware using ClamAV daemon only.
    
    Args:
        file_content: Raw file content bytes
        filename: Original filename
        
    Returns:
        Dictionary with scan results
        
    Raises:
        MalwareDetected: If malware is found
        MalwareScanError: If scanning fails
    """
    return await malware_scanner.scan_file_content(file_content, filename)